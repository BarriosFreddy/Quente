import{u as ge,c as T,r as f,j as e,F as be}from"./index-zLCb2fgV.js";import{t as je,H as oe,I as re,J as ve,D as x,E as o,a5 as ie,a8 as Ne,O as p,b as z,M as Ce,$ as Pe,a0 as Ie,a1 as ke,a3 as Ee,a4 as Re,f as ce,V as Se,W as Te,X as H,Y as L,Z as De,_ as q,a9 as Ae,P as Ue,K as Fe,a7 as Oe}from"./index.esm-CGtd4b9a.js";import{e as qe,P as K,p as w,g as de,u as we,s as ze}from"./DefaultLayout-Dp8_4Mli.js";import{g as Be}from"./item-categories.service-DURexh54.js";import{C as he}from"./CurrencyFormInput-CXjMaF9V.js";import{F as v}from"./FormInput-uIO3-47D.js";import{g as Me}from"./inv-enumerations.service-cECCLzG0.js";import{c as te}from"./cil-trash-Bi1lSbbJ.js";import{e as M,f as me,g as xe}from"./index-CR_XkoXS.js";import{C as Ge}from"./ConfirmDialog-vCIEtcfF.js";import{C as Le}from"./constants-DN2KnU_M.js";import{s as ue}from"./notification.service-CZX6zi9-.js";import{H as Ve}from"./Helmet-C40K-Xy2.js";import{u as _e}from"./useDidUpdateControl-CLy3MrI-.js";import{d as S}from"./dayjs.min-Bvy1Uf3G.js";import{c as He,a as Ke}from"./cil-pencil-c5jg0gho.js";import{c as Je}from"./cil-plus-DmDyxMpI.js";import{c as We}from"./cil-search-C59ySTwT.js";import"./cil-user-Cc0HYXzm.js";import"./SyncService-CJenB6tV.js";import"./DatabaseService-IbC6Bkt9.js";const le="Precio 1",pe=M(),ne={name:"",code:"",description:"",categoryId:"",sku:"",reorderPoint:"",laboratory:"",pricesRatio:[{measurementUnit:"",price:"",cost:"",hash:pe,main:pe,multiplicity:"1",totalCost:"",quantityPerPackage:"1",label:le}],expirationControl:[{lotUnits:"",lot:"",expirationDate:"",id:M()}]};function fe(d){const g=ge(),D=T(s=>s.itemCategories.itemCategories),B=T(s=>s.invEnumerations.invEnumeration),A=T(s=>s.items.existsByCode),P=T(s=>s.items.saving),[a,h]=f.useState(ne),[l,u]=f.useState({code:!1,description:!1,name:!1,reorderPoint:!1,categoryId:!1}),[y,E]=f.useState(!1),R=f.useRef();f.useEffect(()=>{if(d.item){let s=null;d.copying?(s={...d.item,code:""},delete s._id):s=d.item,s.pricesRatio&&s.pricesRatio.length===1&&!s.pricesRatio[0].label&&(s={...s,pricesRatio:[{...s.pricesRatio[0],label:le}]}),s=_(s),h(s)}g(Be({parse:!0})),g(Me("UDM"))},[g,d.item,d.copying]);const J=d.item?.code,G=()=>E(!y),b=s=>{J!==s&&g(qe(s))},W=e.jsx("button",{className:"close",onClick:G,children:"×"}),V=()=>{const{name:s,code:n,description:t,categoryId:m,reorderPoint:C,pricesRatio:j,expirationControl:k}={...a},c={...l};return c.code=!n||A,c.description=!t,c.name=!s,c.categoryId=!m,c.reorderPoint=C<=0||Number.isNaN(+C),j?.forEach(r=>{c["measurementUnit"+r.hash]=!r.measurementUnit,c["price"+r.hash]=r.price<=0||Number.isNaN(+r.price),c["totalCost"+r.hash]=r.totalCost<=0||Number.isNaN(+r.totalCost),c["multiplicity"+r.hash]=r.multiplicity<=0||Number.isNaN(+r.multiplicity),c["quantityPerPackage"+r.hash]=r.quantityPerPackage<=0||Number.isNaN(+r.quantityPerPackage),a.pricesRatio.length>=2?c["label"+r.hash]=!r.label:c.hasOwnProperty("label"+r.hash)&&(c["label"+r.hash]=!1)}),k?.forEach(r=>{c["lotUnits"+r.id]=!r.lotUnits||!Number.isFinite(+r.lotUnits),c["lot"+r.id]=!r.lot,c["expirationDate"+r.id]=!r.expirationDate}),u(c),Object.values(c).every(r=>r===!1)},Y=async()=>{if(V()){let s={...a};s=_(s),delete s.syncStatus,d.onSave(s),h(ne)}},$=()=>{R.current.show(!0)},Q=s=>{if(s){d.onCancel(),h(ne),g(be(!1));return}R.current.show(!1)},I=({target:{name:s,value:n}})=>{h({...a,[s]:n}),u({...l,[s]:!n}),s==="code"&&b(n)},N=(s,n,t)=>{const{target:{name:m,value:C}}=s;let j=[...a.pricesRatio];if(m==="main"){j=j.map(c=>({...c,[m]:C})),h({...a,pricesRatio:j});return}let k=j.find(c=>c.hash===n);k={...k,[m]:C},j[t]=k,(m==="totalCost"||m==="quantityPerPackage")&&(j[t].cost=O(j[t])),h({...a,pricesRatio:j})},X=()=>{const s=se();if((a.pricesRatio??[]).length===0){h({...a,pricesRatio:[{...s,label:le,main:s.hash}]});return}if(a.pricesRatio?.length===1){h({...a,pricesRatio:[{...a.pricesRatio[0],main:a.pricesRatio[0].hash},s]});return}h({...a,pricesRatio:[...a.pricesRatio??[],s]})},U=s=>{let n=[...a.pricesRatio];const t=n.find(C=>C.hash===s),m=n.filter(C=>C.hash!==s);t.main===t.hash&&(m[0]={...m[0],main:m[0].hash}),h({...a,pricesRatio:m})},F=(s,n,t)=>{const{target:{name:m,value:C}}=s;let j=[...a.expirationControl],k=j.find(c=>c.id===n);k={...k,[m]:C},j[t]=k,h({...a,expirationControl:j})},Z=()=>{const s=ae();h({...a,expirationControl:[...a.expirationControl??[],s]})},ee=s=>{const t=[...a.expirationControl].filter(m=>m.id!==s);h({...a,expirationControl:t})};function _(s){const n=JSON.parse(JSON.stringify(s));if(!(!n.pricesRatio||!Array.isArray(n.pricesRatio)))return n.pricesRatio.length===1&&!n.pricesRatio[0].hash?(n.pricesRatio[0].hash=M(),n.pricesRatio[0].main=n.pricesRatio[0].hash,n):(n.pricesRatio=n.pricesRatio.map(t=>{const m={...t},C=M();return m.hash=m.hash?m.hash:C,m}),n)}function se(){const s=M();return{measurementUnit:"",price:"",cost:"",hash:s,main:s,multiplicity:1,totalCost:"",quantityPerPackage:"1",label:""}}function ae(){return{lotUnits:"",lot:"",expirationDate:"",id:M()}}const i=(s,n)=>{const t=Math.round((s-n)*100/n);return t<0||isNaN(t)?0:t},O=({totalCost:s,quantityPerPackage:n})=>s/n;return e.jsxs(e.Fragment,{children:[e.jsx(je,{children:e.jsxs(oe,{children:[e.jsx(re,{children:e.jsxs(ve,{className:"row g-3 needs-validation",noValidate:!0,children:[e.jsxs(x,{children:[e.jsx(o,{xs:"12",lg:"3",children:e.jsx(v,{label:"Código único",type:"text",uppercase:"true",name:"code",value:a.code,feedback:A?"El código ya se encuentra registrado":"Campo obligatorio",invalid:A||l.code,required:!0,onChange:s=>I(s)})}),e.jsx(o,{xs:"12",lg:"3",children:e.jsx(v,{className:"text-uppercase",label:"Nombre",type:"text",uppercase:"true",name:"name",value:a.name,feedbackInvalid:"Campo obligatorio",invalid:l.name,required:!0,onChange:s=>I(s)})}),e.jsx(o,{xs:"12",lg:"6",children:e.jsx(v,{className:"text-uppercase",label:"Descripción",type:"text",uppercase:"true",name:"description",value:a.description,feedbackInvalid:"Campo obligatorio",invalid:l.description,required:!0,onChange:s=>I(s)})})]}),e.jsxs(x,{children:[e.jsx(o,{xs:"12",lg:"3",children:e.jsx(ie,{size:"sm",label:"Categoria",name:"categoryId",value:a.categoryId,required:!0,feedbackInvalid:"Campo obligatorio",invalid:l.categoryId,onChange:s=>I(s),"aria-label":"Default select example",options:["Seleccione la categoria",...D]})}),e.jsx(o,{xs:"12",lg:"3",children:e.jsx(v,{label:"Punto de recompra",type:"tel",min:1,name:"reorderPoint",value:a.reorderPoint,invalid:l.reorderPoint,feedbackInvalid:"Campo obligatorio",onChange:s=>I(s)})}),e.jsx(o,{xs:"12",lg:"3",children:e.jsx(v,{label:"Fabricante (Opcional)",type:"text",uppercase:"true",name:"laboratory",value:a.laboratory,onChange:s=>I(s)})}),e.jsx(o,{xs:"12",lg:"3",children:e.jsx(v,{label:"SKU (Opcional)",type:"text",name:"sku",value:a.sku,onChange:s=>I(s)})})]}),e.jsxs(x,{children:[e.jsxs(o,{md:"12",children:[e.jsx(x,{className:"my-2",children:e.jsx(o,{xs:"12",lg:"12",className:"fw-semibold",children:"Relación de precios"})}),a.pricesRatio?.map((s,n)=>e.jsxs(x,{children:[e.jsx(o,{xs:"12",lg:"2",children:e.jsxs(x,{children:[a.pricesRatio?.length>1&&e.jsx(o,{xs:"1",className:"pt-4",children:e.jsx(Ne,{type:"radio",name:"main",value:s.hash,checked:s.main===s.hash,onChange:t=>N(t,s.hash,n),onClick:t=>N(t,s.hash,n)})}),e.jsx(o,{xs:{offset:0,span:a.pricesRatio?.length>1?10:12},children:e.jsx(ie,{size:"sm",label:"U. de medida",name:"measurementUnit",value:s.measurementUnit,required:!0,feedbackInvalid:"Campo obligatorio",invalid:l["measurementUnit"+s.hash],onChange:t=>N(t,s.hash,n),"aria-label":"Default select example",options:["Seleccione...",...B?.values??[]]})})]})}),e.jsx(o,{xs:"12",lg:"2",children:e.jsx(v,{label:"Nombre",type:"text",name:"label",value:s.label,feedbackInvalid:"Campo obligatorio",invalid:l["label"+s.hash],required:a.pricesRatio.length>=2,onChange:t=>N(t,s.hash,n)})}),e.jsx(o,{xs:"12",lg:"2",children:e.jsx(he,{size:"sm",label:`Precio ${i(s.price,s.cost)}% ↑`,type:"tel",name:"price",value:s.price,feedbackInvalid:"Campo obligatorio",invalid:l["price"+s.hash],required:!0,onChange:t=>N(t,s.hash,n)})}),e.jsx(o,{xs:"12",lg:"2",children:e.jsx(he,{label:"Costo total",type:"tel",name:"totalCost",value:s.totalCost,feedbackInvalid:"Campo obligatorio",invalid:l["totalCost"+s.hash],onChange:t=>N(t,s.hash,n)})}),e.jsx(o,{xs:"12",lg:"2",children:e.jsx(v,{label:"Cantidad",type:"tel",name:"quantityPerPackage",min:1,value:s.quantityPerPackage,feedbackInvalid:"Campo obligatorio",invalid:l["quantityPerPackage"+s.hash],onChange:t=>N(t,s.hash,n)})}),e.jsx(o,{xs:"12",lg:"1",children:e.jsx(v,{label:"Multiplo",type:"tel",name:"multiplicity",min:1,value:s.multiplicity,feedbackInvalid:"Campo obligatorio",invalid:l["multiplicity"+s.hash],onChange:t=>N(t,s.hash,n)})}),a.pricesRatio?.length>1&&e.jsx(o,{xs:"12",lg:"1",children:e.jsx(p,{color:"ligth",className:"mt-4",onClick:()=>U(s.hash),children:e.jsx(z,{icon:te,size:"sm"})})})]},s.hash)),e.jsx(x,{className:"my-2",children:e.jsx(o,{xs:"12",lg:"4",children:e.jsx(p,{variant:"outline",color:"success",type:"button",onClick:X,children:"AGREGAR RELACIÓN"})})})]}),e.jsxs(o,{md:"12",children:[e.jsx(x,{className:"my-2",children:e.jsx(o,{xs:"12",lg:"12",className:"fw-semibold",children:"Control de vencimiento"})}),a.expirationControl?.map((s,n)=>e.jsxs(x,{children:[e.jsx(o,{xs:"12",lg:{offset:0,span:a.expirationControl?.length===1?4:3},children:e.jsx(v,{label:"Cantidad por lote",type:"tel",name:"lotUnits",feedbackInvalid:"Campo obligatorio",invalid:l["lotUnits"+s.id],value:s.lotUnits,onChange:t=>F(t,s.id,n)})}),e.jsx(o,{xs:"12",lg:"4",children:e.jsx(v,{className:"text-uppercase",label:"Lote",type:"text",uppercase:"true",name:"lot",feedbackInvalid:"Campo obligatorio",invalid:l["lot"+s.id],value:s.lot,onChange:t=>F(t,s.id,n)})}),e.jsx(o,{xs:"12",lg:"4",children:e.jsx(Ce,{size:"sm",label:"Fecha de vencimiento",type:"date",name:"expirationDate",feedbackInvalid:"Campo obligatorio",invalid:l["expirationDate"+s.id],value:s.expirationDate,onChange:t=>F(t,s.id,n)})}),a.expirationControl?.length>1&&e.jsx(o,{xs:"12",lg:"1",children:e.jsx(p,{color:"ligth",className:"mt-4",onClick:()=>ee(s.id),children:e.jsx(z,{icon:te,size:"sm"})})})]},n)),e.jsx(x,{className:"my-2",children:e.jsx(o,{xs:"12",lg:"4",children:e.jsx(p,{variant:"outline",color:"success",type:"button",onClick:Z,children:"AGREGAR CONTROL"})})})]})]})]})}),e.jsx(Pe,{className:"mt-2",children:e.jsx(x,{className:"mt-0",children:e.jsxs(o,{className:"text-center",lg:{offset:4,span:4},children:[e.jsx(p,{color:"success",type:"button",disabled:P,onClick:()=>Y(),children:d.item&&d.item?.id?"EDITAR":"GUARDAR"}),"   ",e.jsx(p,{variant:"outline",color:"secondary",onClick:()=>$(),children:"CANCELAR"})]})})})]})}),e.jsx(Ge,{ref:R,onResponse:Q,message:"¿Estás seguro que quieres cancelar?"}),e.jsxs(Ie,{isOpen:y,toggle:G,children:[e.jsx(ke,{toggle:G,close:W,children:"Escaneando"}),e.jsx(Ee,{children:e.jsx("div",{id:"reader",width:"600px",style:{maxWidth:"750px"}})}),e.jsx(Re,{children:e.jsx(p,{color:"secondary",onClick:G,children:"Cancelar"})})]})]})}fe.propTypes={onCancel:K.func.isRequired,onSave:K.func.isRequired,item:K.object,copying:K.bool};const ye=({items:d,fetching:g,page:D,onEdit:B,onCopy:A,onPrevPage:P,onNextPage:a})=>{const h=l=>l?.map(({expirationDate:u,lotUnits:y})=>({expirationDate:u,lotUnits:y}));return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"d-lg-none",children:[d?.map(l=>e.jsx(oe,{style:{width:"auto",cursor:"pointer"},className:"my-2",onClick:()=>B(l),children:e.jsx(re,{children:e.jsxs(x,{className:"g-0",children:[e.jsxs(o,{xs:"7",children:[e.jsx(x,{children:l.name}),e.jsx(x,{children:l.code})]}),e.jsx(o,{xs:"2",className:"text-end",children:h(l.expirationControl)?.filter(({lotUnits:u})=>u>0).map(({expirationDate:u,lotUnits:y},E)=>e.jsx(ce,{color:S(u).diff(S(),"days")>90?S(u).diff(S(),"days")>180?"success":"warning":"danger",shape:"rounded-pill",children:y},E))}),e.jsx(o,{xs:"3",className:"text-end fw-bold",children:me(xe(l?.pricesRatio))})]})})},l.code)),e.jsx(x,{children:e.jsxs(o,{className:"py-1 text-center",children:["Página ",D]})}),e.jsxs(x,{children:[e.jsx(o,{children:e.jsx("div",{className:"d-grid col-12 mx-auto",children:e.jsx(p,{type:"button",variant:"outline",color:"secondary",disabled:g,onClick:P,children:"ANTERIOR"})})}),e.jsx(o,{children:e.jsx("div",{className:"d-grid col-12 mx-auto",children:e.jsx(p,{type:"button",variant:"outline",color:"secondary",disabled:g,onClick:a,children:"SIGUIENTE"})})})]})]}),e.jsx("div",{className:"d-none d-lg-block",children:e.jsxs(Se,{hover:!0,children:[e.jsx(Te,{children:e.jsxs(H,{children:[e.jsx(L,{scope:"col",children:"Nombre"}),e.jsx(L,{scope:"col",children:"Código"}),e.jsx(L,{scope:"col",children:"En Stock"}),e.jsx(L,{scope:"col",children:"Precio"}),e.jsx(L,{scope:"col",children:"Acciones"})]})}),e.jsx(De,{children:d?.map(l=>e.jsxs(H,{children:[e.jsx(q,{className:"text-uppercase text-break",children:l.name}),e.jsx(q,{children:l.code}),e.jsx(q,{children:h(l.expirationControl)?.filter(({lotUnits:u})=>u>0).map(({expirationDate:u,lotUnits:y},E)=>e.jsx(ce,{color:S(u).diff(S(),"days")>90?S(u).diff(S(),"days")>180?"success":"warning":"danger",shape:"rounded-pill",children:y},E))}),e.jsx(q,{children:me(xe(l?.pricesRatio))}),e.jsxs(q,{children:[e.jsxs(p,{size:"sm",variant:"outline",color:"info",disabled:g,onClick:()=>B(l),children:[e.jsx(z,{icon:He,size:"sm"}),"  EDITAR"]})," ",e.jsxs(p,{size:"sm",variant:"outline",color:"secondary",disabled:g,onClick:()=>A(l),children:[e.jsx(z,{icon:Ke,size:"sm"}),"  COPIAR"]})]})]},l.code))}),e.jsxs(Ae,{children:[e.jsx(H,{children:e.jsxs(q,{colSpan:5,className:"text-center",children:["Página ",D]})}),e.jsx(H,{className:"mt-2",children:e.jsx(q,{colSpan:5,children:e.jsxs(x,{children:[e.jsx(o,{children:e.jsx("div",{className:"d-grid col-12 mx-auto",children:e.jsx(p,{type:"button",variant:"outline",color:"secondary",disabled:g,onClick:P,children:"ANTERIOR"})})}),e.jsx(o,{children:e.jsx("div",{className:"d-grid col-12 mx-auto",children:e.jsx(p,{type:"button",variant:"outline",color:"secondary",disabled:g,onClick:a,children:"SIGUIENTE"})})})]})})})]})]})})]})};ye.propTypes={items:w.PropTypes.array.isRequired,page:w.PropTypes.number.isRequired,fetching:w.PropTypes.bool.isRequired,onEdit:w.PropTypes.func.isRequired,onCopy:w.PropTypes.func.isRequired,onPrevPage:w.PropTypes.func.isRequired,onNextPage:w.PropTypes.func.isRequired};const{ENTER_KEYCODE:Ye,TAB_KEYCODE:$e}=Le,Qe={page:1};function ys(){const d=ge(),g=T(i=>i.items.items),D=T(i=>i.items.saveSuccess),B=T(i=>i.items.saving),A=T(i=>i.items.fetching),[P,a]=f.useState("");let[h,l]=f.useState(!1),[u,y]=f.useState(!1),[E,R]=f.useState(null);const[J,G]=f.useState(!1),[b,W]=f.useState(Qe),V=f.useRef();f.useEffect(()=>{a(""),d(de({page:1}))},[d]),_e(()=>{D?(l(!1),ue(d,{message:"Guardado exitosamente!"}),R(null),F({page:b.page})):ue(d,{message:"No se pudo guardar los datos, intente nuevamente!",color:"danger"})},B,[D]);const Y=i=>{delete i.price,delete i.measurementUnit,delete i.cost,i._id?d(we(i)):d(ze(i))},$=async()=>{l(!1)},Q=async()=>{const i={...b,page:b.page===1?1:b.page-1};U(i)},I=async()=>{const i={...b,page:b.page+1};U(i)},N=({target:{value:i}})=>a(i),X=async({keyCode:i})=>{[Ye,$e].includes(i)&&F({page:1})},U=async(i={})=>{W(i),d(de(i))},F=(i={})=>{const O={...i};P&&(O.code=P.trim(),O.name=P.trim()),U(O)},Z=i=>{l(!0),y(!1),R(i)},ee=i=>{y(!0),l(!0),R(i)},_=()=>{R(null),l(!0),y(!1)},se=()=>{a(""),U({page:1}),V.current.focus()},ae=({target:{name:i,value:O}})=>{const s={...b,page:1,[i]:O};U(s)};return e.jsx(e.Fragment,{children:e.jsxs(je,{children:[e.jsx(Ve,{children:e.jsx("title",{children:"ITEMS"})}),e.jsxs(oe,{className:"shadow border-10",children:[e.jsxs(Ue,{children:[!h&&e.jsx(e.Fragment,{children:e.jsxs(x,{children:[e.jsx(o,{xs:"2",lg:"3",children:e.jsxs(p,{variant:"outline",color:"success",onClick:_,children:[e.jsx("div",{className:"d-none d-lg-block",children:"NUEVO"}),e.jsx("div",{className:"d-lg-none",children:e.jsx(z,{icon:Je,size:"sm"})})]})}),e.jsx(o,{xs:"8",lg:"5",children:e.jsxs(Fe,{children:[e.jsx(Ce,{ref:V,type:"text",name:"searchTerm",placeholder:"...",value:P,onChange:i=>N(i),onKeyDown:i=>X(i)}),e.jsxs(p,{type:"button",variant:"outline",color:"primary",onClick:()=>F({page:1}),children:[e.jsx("div",{className:"d-none d-lg-block",children:"BUSCAR"}),e.jsx("div",{className:"d-lg-none",children:e.jsx(z,{icon:We,size:"sm"})})]}),e.jsxs(p,{variant:"outline",type:"button",color:"secondary",onClick:se,children:[e.jsx("div",{className:"d-none d-lg-block",children:"BORRAR"}),e.jsx("div",{className:"d-lg-none",children:e.jsx(z,{icon:te,size:"sm"})})]})]})}),J&&e.jsxs(e.Fragment,{children:[e.jsx(o,{xs:"2",lg:"1",className:"text-end",children:e.jsx(Oe,{htmlFor:"stock",className:"col-form-label",children:"Stock"})}),e.jsx(o,{xs:"4",lg:"2",children:e.jsx(ie,{id:"stock",className:"my-1",value:b.stock,name:"stock",size:"sm",options:[{label:"TODOS",value:""},{label:"DISPONIBLE",value:"IS"},{label:"RECOMPRA",value:"RP"},{label:"NO DISPONIBLE",value:"WS"}],onChange:ae})})]})]})}),h&&e.jsxs("div",{children:[E?u?"COPIANDO":"EDITANDO":"CREANDO"," ITEM"]})]}),e.jsxs(re,{children:[!h&&e.jsx(ye,{items:g,page:b.page,fetching:A,onEdit:Z,onCopy:ee,onPrevPage:Q,onNextPage:I}),h&&e.jsx(fe,{copying:u,item:E,onSave:Y,onCancel:$})]})]})]})})}export{ys as default};
