import{a9 as Y,aa as Oe,ab as _e,ac as le,ad as qe,ae as Q,af as ce,ag as ye,ah as fe,r as j,u as X,c as P,j as e}from"./index-zLCb2fgV.js";import{H as Ue}from"./Helmet-C40K-Xy2.js";import{D as y,a7 as T,E as n,K as Se,M as H,V as se,Z as te,X as U,_ as w,H as W,P as ne,I as G,J as $e,O as N,b as z,N as K,aa as Be,$ as ve,r as me,t as we,f as ue,W as he,Y as I,Q as ze,a0 as He,a1 as We,a3 as Ge,a5 as Pe,a4 as Ke,a6 as Ye,a9 as Qe}from"./index.esm-CGtd4b9a.js";import{g as oe,P as R}from"./DefaultLayout-Dp8_4Mli.js";import{C as xe}from"./CurrencyFormInput-CXjMaF9V.js";import{F as ee}from"./FormInput-uIO3-47D.js";import{f as F,g as ge,d as J}from"./index-CR_XkoXS.js";import{C as Ze}from"./ConfirmDialog-vCIEtcfF.js";import{c as Ae}from"./cil-trash-Bi1lSbbJ.js";import{C as Je}from"./ClientSearchComponent-B4X3wan7.js";import{a as je}from"./notification.service-CZX6zi9-.js";import{c as Xe}from"./cil-arrow-left-XthWZumH.js";import{c as De}from"./cil-plus-DmDyxMpI.js";import{u as be}from"./useDidUpdateControl-CLy3MrI-.js";import{c as ea}from"./cil-filter-p6GwuJOR.js";import{c as aa}from"./cil-search-C59ySTwT.js";import"./cil-user-Cc0HYXzm.js";import"./SyncService-CJenB6tV.js";import"./DatabaseService-IbC6Bkt9.js";import"./dayjs.min-Bvy1Uf3G.js";import"./Clients-DVxdOLBe.js";import"./constants-DN2KnU_M.js";import"./cil-pencil-c5jg0gho.js";const sa=i=>async(o,h,p)=>{o(Q(!0));try{const{status:s,data:t}=await p.post("/layaways",i);return s===201?(o(ce(!0)),o(le(t)),t):(o(ce(!1)),null)}catch(s){return console.error("Error saving layaway:",s),o(ce(!1)),null}finally{o(Q(!1))}},ie=(i={})=>async(o,h,p)=>{o(Y(!0));try{let s="/layaways",t="";const d={...i};if(Object.keys(d).length>0){const b=[];d.dateRange&&(d.dateRange.fromDate&&b.push(`filters[dateRange][fromDate]=${encodeURIComponent(d.dateRange.fromDate)}`),d.dateRange.toDate&&b.push(`filters[dateRange][toDate]=${encodeURIComponent(d.dateRange.toDate)}`),delete d.dateRange),Object.entries(d).forEach(([S,g])=>{g!=null&&(S==="status"?b.push(`filters[status]=${encodeURIComponent(g)}`):b.push(`${encodeURIComponent(S)}=${encodeURIComponent(g)}`))}),b.length>0&&(t="?"+b.join("&"))}s+=t;const{data:x,status:f}=await p.get(s);return f===200&&(o(Oe(x?.data)),o(_e(x.pagination))),x}catch(s){return console.error("Error fetching layaways:",s),null}finally{o(Y(!1))}},Ce=i=>async(o,h,p)=>{o(Y(!0));try{const{data:s,status:t}=await p.get(`/layaways/${i}`);return t===200?(o(le(s)),s):null}catch(s){return console.error("Error fetching layaway:",s),null}finally{o(Y(!1))}},ta=(i,o)=>async(h,p,s)=>{h(Q(!0));try{const{data:t,status:d}=await s.post(`/layaways/${i}/payments`,o);return h(fe(d===200)),d===200?(h(le(t)),h(Ie(i)),t):null}catch(t){return console.error("Error adding payment:",t),h(fe(!1)),null}finally{h(Q(!1))}},Ie=i=>async(o,h,p)=>{o(Y(!0));try{const{data:s,status:t}=await p.get(`/layaways/${i}/payments`);return t===200?(o(qe(s)),s):[]}catch(s){return console.error("Error fetching layaway payments:",s),[]}finally{o(Y(!1))}},Ne=(i,o)=>async(h,p,s)=>{h(Q(!0));try{const{data:t,status:d}=await s.patch(`/layaways/${i}/status`,o);return h(ye(d===200)),d===200?(h(le(t)),t):null}catch(t){return console.error("Error updating layaway status:",t),h(ye(!1)),null}finally{h(Q(!1))}},Le=j.forwardRef(function(o,h){const p=X(),s=P(l=>l.items.items),[t,d]=j.useState(null),x=j.useRef(),f=j.useRef(),[b,S]=j.useState(!1),[g,u]=j.useState(!1),[A,D]=j.useState("");j.useEffect(()=>{o.defaultValue&&p(oe({code:o.defaultValue}))},[p,o.defaultValue]),j.useEffect(()=>{o.defaultItem&&d(o.defaultItem)},[o.defaultItem]),j.useEffect(()=>{function l(c){f.current&&!f.current.contains(c.target)&&S(!1)}return b&&document.addEventListener("mousedown",l),()=>{document.removeEventListener("mousedown",l)}},[b]),j.useImperativeHandle(h,()=>({getSelected(){return t},setSelected(l){d(l)},clear(){d(null),D("")}}),[t]);const O=({target:{value:l}})=>{D(l),l&&p(oe({name:l,code:l}))},_=()=>{S(!0)},$=_,L=l=>{u(!1),S(!1),d(l),o.onSelect&&o.onSelect(l)},k=()=>{u(!0),setImmediate(()=>{x.current?.focus()}),p(oe({name:A,code:A}))},B=k,r=l=>l?`${l?.name||""} (${l?.code||""})`:"";return e.jsx(e.Fragment,{children:e.jsxs(y,{ref:f,children:[e.jsx(T,{htmlFor:"searchInput",className:"col-sm-2 col-form-label d-none d-md-block",children:o.label||"Artículo:"}),e.jsxs(n,{children:[e.jsxs(Se,{children:[g&&e.jsx(H,{id:"searchInput",ref:x,type:"text",formNoValidate:!0,size:"sm",value:A,placeholder:"Buscar artículo...",onChange:l=>O(l),onClick:_,onFocus:$,onBlur:()=>o.allowBlur&&u(!1)}),!g&&e.jsx(H,{type:"text",formNoValidate:!0,size:"sm",value:r(t),readOnly:!0,placeholder:o.placeholder||"Seleccione un artículo...",onClick:k,onFocus:B})]}),b&&s&&s.length>0&&e.jsx("div",{className:"item-list",style:{maxHeight:150,width:x.current?.offsetWidth||200},children:e.jsx(se,{hover:!0,small:!0,borderless:!0,style:{marginBottom:0},children:e.jsx(te,{children:s.map((l,c)=>e.jsx(U,{active:t&&t.code===l.code,onClick:()=>L(l),children:e.jsxs(w,{children:[e.jsx("div",{children:l.name}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#6c757d"},children:[l.code," - Stock: ",l.stock||0]})]})},c))})})}),b&&(!s||s.length===0)&&A&&e.jsx("div",{className:"item-list",style:{maxHeight:150,width:x.current?.offsetWidth||200,padding:"10px",textAlign:"center"},children:"No se encontraron resultados"})]})]})})});Le.propTypes={onSelect:R.func,defaultValue:R.string,defaultItem:R.object,label:R.string,placeholder:R.string,allowBlur:R.bool};const Ee={customerName:"",customerId:"",customerPhone:"",customerEmail:"",items:[],totalAmount:0,initialPayment:0,remainingAmount:0,paidAmount:0,paymentDueDate:"",notes:"",status:"ACTIVE"};function Te(i){const o=X(),{name:h,id:p}=P(r=>r.auth.infoUser)??{},s=P(r=>r.layaways.saving),[t,d]=j.useState(Ee),[x,f]=j.useState({customerName:!1,initialPayment:!1,items:!1}),b=j.useRef(),S=j.useRef();j.useEffect(()=>{i.layaway?d(i.layaway):d(Ee)},[i.layaway]);const g=r=>{const C=(r.items||[]).reduce((v,q)=>{const Z=(q.quantity||0)*(parseFloat(q.unitPrice)||0);return v+Z},0),a=parseFloat(r.initialPayment)||0,E=Math.max(0,C-a);return{...r,totalAmount:C,remainingAmount:E,paidAmount:a}},u=({target:{name:r,value:l}})=>{const c={...t,[r]:l};if(r==="initialPayment"){const C=g(c);d(C)}else d(c);f({...x,[r]:!l})},A=(r,l,c)=>{const{name:C,value:a}=r.target,E=[...t.items],v={...E[c],[C]:a};(C==="quantity"||C==="unitPrice")&&(v.subtotal=(v.quantity||0)*(parseFloat(v.unitPrice)||0)),E[c]=v;const q={...t,items:E},Z=g(q);d(Z)},D=r=>t.items.some(({code:l})=>l===r),O=r=>{if(t.items.length<=1)return;const l=t.items.filter(a=>a.id!==r),c={...t,items:l},C=g(c);d(C)},_=()=>{const r=b.current?.getSelected();if(console.log({selectedClient:r}),!r){je(o,{message:"Selecciona el cliente!"});return}if(!(t.paymentDueDate?new Date(t.paymentDueDate):null)){je(o,{message:"Ingrese la fecha del acuerdo"});return}const c={...x};c.customerName=!t.customerName;let C=!0;return t.items.forEach((a,E)=>{const v=`itemName${E}`,q=`itemPrice${E}`;c[v]=!a.name,c[q]=!a.unitPrice||parseFloat(a.unitPrice)<=0,(!a.name||!a.unitPrice||parseFloat(a.unitPrice)<=0)&&(C=!1)}),c.items=!C,c.initialPayment=t.initialPayment<0,c.totalAmount=t.totalAmount<=0,f(c),Object.values(c).every(a=>a===!1)},$=()=>{if(_()){const r=b.current?.getSelected();let l={totalAmount:parseFloat(t.totalAmount),initialPayment:parseFloat(t.initialPayment),expectedDeliveryDate:new Date(t.paymentDueDate),client:{id:r._id,name:r.name,email:t.customerEmail,phoneNumber:t.customerPhone},items:t.items.map(c=>({_id:"64643f01e21a9b579e003f50",code:"7703038020028",name:c.name,price:parseFloat(c.unitPrice),units:parseInt(c.quantity,10)})),createdBy:{id:p,name:h},notes:t.notes||""};i.onSave(l)}},L=t.remainingAmount===0&&t.totalAmount>0,k=r=>{r&&(d({...t,customerName:r.name,customerId:r._id,customerPhone:r.phoneNumber,customerEmail:r.email}),f({...x,customerName:!1}))},B=r=>{if(D(r.code)){const l=t.items.map(a=>{if(a.code===r.code){const E=(parseInt(a.quantity,10)||0)+1,v=E*parseFloat(a.unitPrice);return{...a,quantity:E,subtotal:v}}return a}),c={...t,items:l},C=g(c);d(C)}else{const l={id:Date.now().toString(),code:r.code,name:r.name,quantity:1,unitPrice:ge(r.pricesRatio),subtotal:ge(r.pricesRatio)},c={...t,items:[...t.items||[],l]},C=g(c);d(C)}S.current?.clear()};return e.jsx(e.Fragment,{children:e.jsxs(W,{className:"shadow border-10 mb-5",children:[e.jsx(ne,{children:"PLAN SEPARE"}),e.jsx(G,{children:e.jsxs($e,{children:[e.jsxs(y,{className:"mb-4",children:[e.jsx(n,{md:"12",children:e.jsx("h5",{children:"Información del Cliente"})}),e.jsx(n,{md:"12",className:"mb-3",children:e.jsx(Je,{ref:b,onSelect:k})}),e.jsxs(n,{md:"6",className:"mb-3",children:[e.jsx(T,{children:"Teléfono"}),e.jsx(ee,{type:"text",name:"customerPhone",value:t.customerPhone,onChange:u,disabled:!0})]}),e.jsxs(n,{md:"6",className:"mb-3",children:[e.jsx(T,{children:"Correo Electrónico"}),e.jsx(ee,{type:"email",name:"customerEmail",value:t.customerEmail,onChange:u,disabled:!0})]}),e.jsxs(n,{md:"6",className:"mb-3",children:[e.jsx(T,{children:"Fecha Límite de Pago"}),e.jsx(H,{type:"date",name:"paymentDueDate",value:t.paymentDueDate,onChange:r=>u(r),disabled:s})]})]}),e.jsxs(y,{className:"mb-4",children:[e.jsx(n,{md:"12",className:"d-flex justify-content-between align-items-center mb-3",children:e.jsx("h5",{children:"Artículos"})}),e.jsx(n,{md:"12",children:e.jsx(Le,{label:"Seleccione el articulo",ref:S,onSelect:B})}),e.jsx(n,{md:"12",children:e.jsxs(y,{className:"border-bottom pb-2 mb-3 fw-bold",children:[e.jsx(n,{md:"4",children:"Nombre*"}),e.jsx(n,{md:"2",children:"Cantidad*"}),e.jsx(n,{md:"2",children:"Precio Unitario*"}),e.jsx(n,{md:"3",children:"Subtotal"}),e.jsx(n,{md:"1",children:"Acciones"})]})}),t.items.map((r,l)=>e.jsx(n,{md:"12",children:e.jsxs(y,{className:"mb-3 align-items-center",children:[e.jsx(n,{md:"4",children:e.jsx(ee,{type:"text",name:"name",value:r.name,onChange:c=>A(c,r.id,l),invalid:x[`itemName${l}`],disabled:!0})}),e.jsx(n,{md:"2",children:e.jsx(ee,{type:"number",min:"1",name:"quantity",value:r.quantity,onChange:c=>A(c,r.id,l),disabled:s})}),e.jsx(n,{md:"2",children:e.jsx(xe,{name:"unitPrice",value:r.unitPrice,onChange:c=>A(c,r.id,l),invalid:x[`itemPrice${l}`],disabled:s})}),e.jsx(n,{md:"3",children:e.jsx("div",{className:"form-control bg-light",children:F(r.subtotal||0)})}),e.jsx(n,{md:"1",children:e.jsx(N,{color:"danger",variant:"outline",size:"sm",onClick:()=>O(r.id),disabled:s||t.items.length<=1,children:e.jsx(z,{icon:Ae,size:"sm"})})})]})},r.id)),x.items&&e.jsx(n,{md:"12",className:"mb-3",children:e.jsx(K,{color:"danger",className:"p-2",children:"Por favor complete la información de todos los artículos"})})]}),e.jsxs(y,{className:"mb-4",children:[e.jsx(n,{md:"12",children:e.jsx("h5",{children:"Información de Pago"})}),e.jsxs(n,{md:"4",className:"mb-3",children:[e.jsx(T,{children:"Pago Inicial*"}),e.jsx(xe,{name:"initialPayment",value:t.initialPayment,onChange:u,invalid:x.initialPayment,disabled:s}),e.jsx(Be,{invalid:!0,children:"El pago inicial no puede ser negativo"})]}),e.jsxs(n,{md:"4",className:"mb-3",children:[e.jsx(T,{children:"Monto Total"}),e.jsx("div",{className:"form-control bg-light fw-bold",children:F(t.totalAmount||0)})]}),e.jsxs(n,{md:"4",className:"mb-3",children:[e.jsx(T,{children:"Saldo Restante"}),e.jsx("div",{className:`form-control bg-light fw-bold ${L?"text-success":""}`,children:F(t.remainingAmount||0)})]})]}),e.jsxs(y,{className:"mb-4",children:[e.jsx(n,{md:"12",children:e.jsx("h5",{children:"Información Adicional"})}),e.jsxs(n,{md:"12",className:"mb-3",children:[e.jsx(T,{children:"Notas"}),e.jsx(H,{type:"textarea",rows:"3",name:"notes",value:t.notes,onChange:u,disabled:s})]})]}),x.totalAmount&&e.jsx(y,{className:"mb-3",children:e.jsx(n,{md:"12",children:e.jsx(K,{color:"danger",className:"p-2",children:"El monto total debe ser mayor a cero"})})}),e.jsx(y,{className:"mb-3",children:e.jsx(n,{md:"12",children:L&&e.jsx(K,{color:"success",className:"p-2",children:"¡Este plan separe está completamente pagado!"})})})]})}),e.jsx(ve,{className:"mt-2",children:e.jsx(y,{className:"mt-0",children:e.jsxs(n,{className:"text-center",lg:{offset:4,span:4},children:[e.jsx(N,{color:"success",type:"button",disabled:s,onClick:$,children:s?e.jsxs(e.Fragment,{children:[e.jsx(me,{size:"sm",className:"me-2"}),"Guardando..."]}):i.layaway&&i.layaway?._id?"ACTUALIZAR":"GUARDAR"}),"   ",e.jsx(N,{variant:"outline",color:"secondary",onClick:i.onCancel,children:"CANCELAR"})]})})})]})})}Te.propTypes={onCancel:R.func.isRequired,onSave:R.func.isRequired,layaway:R.object};const de={ACTIVE:{label:"ACTIVO",color:"primary",description:"El plan separe está activo y pendiente de pagos."},CANCELED:{label:"CANCELADO",color:"danger",description:"El plan separe ha sido cancelado."},DELIVERED:{label:"ENTREGADO",color:"success",description:"El plan separe ha sido entregado al cliente."},COMPLETED:{label:"COMPLETADO",color:"success",description:"El plan separe ha sido completado."}};function na({onBack:i}){const{name:o,id:h}=P(m=>m.auth.infoUser)??{},p=X(),s=P(m=>m.layaways.layaway),t=P(m=>m.layaways.payments),d=P(m=>m.layaways.fetching),x=P(m=>m.layaways.saving),f=P(m=>m.layaways.addPaymentSuccess),b=P(m=>m.layaways.updateStatusSuccess);P(m=>m.auth.user);const[S,g]=j.useState(!1),[u,A]=j.useState(!1),[D,O]=j.useState({amount:"",paymentMethod:""}),[_,$]=j.useState({status:"",reason:""}),[L,k]=j.useState({amount:!1,paymentMethod:!1}),[B,r]=j.useState({status:!1}),l=s?.remainingAmount===0&&s?.totalAmount>0,c=l&&s?.status==="COMPLETED",C=s?.status==="ACTIVE",a=C&&!l,E=c,v=j.useRef();be(async()=>{f?(g(!1),O({amount:"",paymentMethod:""})):sendToast(p,{message:"No se pudo guardar los datos",color:"danger"})},x,[f]),be(async()=>{b&&(A(!1),$({status:"",reason:""}))},x,[b]);const q=()=>!s?.totalAmount||s.totalAmount===0?0:Math.round(s.paidAmount/s.totalAmount*100),Z=()=>{O({amount:"",paymentMethod:""}),k({amount:!1,paymentMethod:!1}),g(!0)},pe=({target:{name:m,value:M}})=>{O({...D,[m]:M}),m==="amount"?k({...L,amount:!M||parseFloat(M)<=0||parseFloat(M)>s?.remainingAmount}):m==="paymentMethod"&&k({...L,paymentMethod:!M})},Fe=()=>{const m=parseFloat(D.amount),M=D.paymentMethod,re={amount:!m||m<=0||m>s?.remainingAmount,paymentMethod:!M};if(re.amount||re.paymentMethod){k(re);return}p(ta(s._id,{amount:m,paymentMethod:M,createdBy:{id:h,name:o}}))},ke=()=>{v.current.show(!0)},Me=m=>{m&&p(Ne(s._id,{status:"CANCELED",reason:"Cancelado por el usuario"})),v.current.show(!1)},Ve=()=>{$({status:"DELIVERED",reason:""}),p(Ne(s._id,{status:"DELIVERED"}))};return e.jsxs(e.Fragment,{children:[e.jsx(we,{children:d?e.jsx("div",{className:"text-center my-5",children:e.jsx(me,{})}):s?e.jsxs(e.Fragment,{children:[e.jsxs(W,{className:"shadow border-10 mb-4",children:[e.jsx(ne,{children:e.jsxs(y,{children:[e.jsx(n,{children:e.jsxs(N,{color:"primary",variant:"outline",onClick:i,children:[e.jsx(z,{icon:Xe,size:"sm",className:"me-1"})," Volver"]})}),e.jsx(n,{children:e.jsx("h4",{children:"Información del plan separe"})}),e.jsx(n,{className:"text-end",children:s&&s.status&&de[s.status]&&e.jsx(ue,{color:de[s.status].color,children:de[s.status].label})})]})}),e.jsxs(G,{children:[e.jsxs(y,{children:[e.jsxs(n,{md:"6",className:"mb-3",children:[e.jsx("h5",{children:"Cliente"}),e.jsx("p",{className:"fs-5 mb-1",children:s.client.name}),s.client.phoneNumber&&e.jsxs("p",{className:"mb-1",children:["Teléfono: ",s.client.phoneNumber]}),s.client.email&&e.jsxs("p",{className:"mb-1",children:["Correo electrónico: ",s.client.email]})]}),e.jsxs(n,{md:"6",className:"mb-3",children:[e.jsx("h5",{children:"Detalles"}),e.jsxs("p",{className:"mb-1",children:["Fecha de Creación: ",J(s.createdAt)]}),s.paymentDueDate&&e.jsxs("p",{className:"mb-1",children:["Fecha Límite de Pago: ",J(s.paymentDueDate)]}),s.notes&&e.jsxs("p",{className:"mb-1",children:["Notas: ",s.notes]})]})]}),e.jsx(y,{children:e.jsxs(n,{md:"12",className:"mb-3",children:[e.jsx("h5",{children:"Artículos"}),e.jsxs(se,{small:!0,bordered:!0,hover:!0,className:"mt-2",children:[e.jsx(he,{children:e.jsxs(U,{children:[e.jsx(I,{children:"Nombre"}),e.jsx(I,{children:"Cantidad"}),e.jsx(I,{children:"Precio Unitario"}),e.jsx(I,{children:"Subtotal"})]})}),e.jsx(te,{children:s.items?.map((m,M)=>e.jsxs(U,{children:[e.jsx(w,{children:m.name}),e.jsx(w,{children:m.units}),e.jsx(w,{children:F(m.price)}),e.jsx(w,{children:F(m.price*m.units)})]},M))})]})]})}),e.jsxs(y,{className:"mb-2",children:[e.jsx(n,{md:"4",children:e.jsxs("div",{className:"border rounded p-3",children:[e.jsx("h5",{className:"mb-3",children:"Monto Total"}),e.jsx("div",{className:"fs-3 fw-bold",children:F(s.totalAmount)})]})}),e.jsx(n,{md:"4",children:e.jsxs("div",{className:"border rounded p-3",children:[e.jsx("h5",{className:"mb-3",children:"Pagado"}),e.jsx("div",{className:"fs-3 fw-bold",children:F(s.paidAmount)})]})}),e.jsx(n,{md:"4",children:e.jsxs("div",{className:"border rounded p-3",children:[e.jsx("h5",{className:"mb-3",children:"Saldo Restante"}),e.jsx("div",{className:"fs-3 fw-bold",children:F(s.remainingAmount)})]})})]}),e.jsx(y,{className:"mt-4",children:e.jsxs(n,{md:"12",children:[e.jsx("h5",{children:"Progreso de Pago"}),e.jsx(ze,{value:q(),className:"mt-2",height:30,children:e.jsxs("div",{className:"fw-bold text-center",style:{lineHeight:"30px"},children:[q(),"%"]})}),l&&e.jsx(K,{color:"success",className:"mt-3 mb-0",children:"¡Este plan separe está completamente pagado!"})]})})]}),e.jsx(ve,{children:e.jsx(y,{children:e.jsxs(n,{className:"text-end",children:[E&&e.jsx(N,{color:"success",onClick:Ve,disabled:x,className:"me-2",children:"Marcar como Entregado"}),a&&e.jsxs(N,{color:"primary",onClick:Z,disabled:x,className:"me-2",children:[e.jsx(z,{icon:De,size:"sm",className:"me-1"})," Agregar Pago"]}),C&&e.jsx(N,{color:"danger",variant:"outline",onClick:ke,disabled:x,className:"me-2",children:"Cancelar plan separe"})]})})})]}),e.jsxs(W,{className:"shadow border-10 mb-4",children:[e.jsx(ne,{children:e.jsx("h4",{children:"Historial de Pagos"})}),e.jsx(G,{children:t?.length===0?e.jsx(K,{color:"info",children:"No hay pagos registrados para este plan separe"}):e.jsxs(se,{striped:!0,bordered:!0,hover:!0,children:[e.jsx(he,{children:e.jsxs(U,{children:[e.jsx(I,{children:"Fecha"}),e.jsx(I,{children:"Monto"}),e.jsx(I,{children:"Descripción"})]})}),e.jsx(te,{children:t?.map((m,M)=>e.jsxs(U,{children:[e.jsx(w,{children:J(m.createdAt)}),e.jsx(w,{children:F(m.amount)}),e.jsx(w,{children:m.description||"N/A"})]},M))})]})})]})]}):e.jsx(K,{color:"warning",children:"No se encontró el plan separe solicitado"})}),e.jsxs(He,{visible:S,onClose:()=>g(!1),children:[e.jsx(We,{children:"Agregar Pago"}),e.jsxs(Ge,{children:[e.jsx(y,{className:"mb-3",children:e.jsxs(n,{md:"12",children:[e.jsx(T,{children:"Monto*"}),e.jsx(xe,{name:"amount",value:D.amount,onChange:pe,invalid:L.amount,disabled:x}),L.amount&&e.jsx("div",{className:"invalid-feedback d-block",children:D.amount?parseFloat(D.amount)<=0?"El monto debe ser mayor a cero":"El monto no puede ser mayor al saldo restante":"El monto es requerido"})]})}),e.jsx(y,{className:"mb-3",children:e.jsxs(n,{md:"12",children:[e.jsx(T,{children:"Método de pago*"}),e.jsxs(Pe,{name:"paymentMethod",value:D.paymentMethod,onChange:pe,invalid:L.paymentMethod,disabled:x,children:[e.jsx("option",{value:"",children:"Seleccionar método de pago"}),e.jsx("option",{value:"CASH",children:"EFECTIVO"}),e.jsx("option",{value:"TRANSFER",children:"TRANSFERENCIA"})]}),L.paymentMethod&&e.jsx("div",{className:"invalid-feedback d-block",children:"El método de pago es requerido"})]})})]}),e.jsxs(Ke,{children:[e.jsx(N,{color:"secondary",onClick:()=>g(!1),disabled:x,children:"Cancelar"}),e.jsx(N,{color:"primary",onClick:Fe,disabled:x,children:x?e.jsxs(e.Fragment,{children:[e.jsx(me,{size:"sm",className:"me-2"}),"Guardando..."]}):"Guardar Pago"})]})]}),e.jsx(Ze,{ref:v,onResponse:Me,title:"Cancelar Plan Separe",message:"¿Está seguro que desea cancelar este plan separe? Esta acción no se puede deshacer."})]})}const la={page:1,limit:10},ae={ACTIVE:{label:"ACTIVO",color:"primary"},DELIVERED:{label:"ENTREGADO",color:"success"},CANCELED:{label:"CANCELADO",color:"danger"}};function Re(i){const o=X(),[h,p]=j.useState(""),[s,t]=j.useState(!1),[d,x]=j.useState(la),[f,b]=j.useState({status:"",startDate:"",endDate:""}),S=P(a=>a.layaways.layaways),g=P(a=>a.layaways.fetching),u=P(a=>a.layaways.pagination);j.useEffect(()=>{p("")},[]);const A=({target:{value:a}})=>p(a),D=async({keyCode:a})=>{[ENTER_KEYCODE,TAB_KEYCODE].includes(a)&&i.onSearch({page:1})},O=()=>{i.onNew()},_=({target:{name:a,value:E}})=>{const v={...f,[a]:E};if(a==="endDate"&&v.startDate&&new Date(E)<new Date(v.startDate)){je(o,{message:"La fecha final debe ser mayor o igual a la fecha inicial"});return}b(v)},$=()=>{const a={...d,page:1};f.status&&(a.status=f.status),(f.startDate||f.endDate)&&(a.dateRange={},f.startDate&&(a.dateRange.fromDate=f.startDate),f.endDate&&(a.dateRange.toDate=f.endDate)),i.onSearch(a)},L=()=>{b({status:"",startDate:"",endDate:""}),i.onSearch({page:1})},k=()=>{const a={...d,page:d.page===1?1:d.page-1};i.onSearch(a)},B=()=>{const a={...d,page:d.page+1};i.onSearch(a)},r=()=>{p("");const a={page:1};i.onSearch(a)},l=()=>{t(!s)},c=a=>!a.totalAmount||a.totalAmount===0?0:Math.round(a.paidAmount/a.totalAmount*100),C=(a={})=>{const E={...a};h.trim()&&(E.search=h.trim()),i.onSearch(E)};return e.jsxs(W,{className:"shadow border-10",children:[e.jsxs(ne,{children:[e.jsxs(y,{children:[e.jsx(n,{xs:"2",lg:"2",children:e.jsxs(N,{variant:"outline",color:"success",onClick:O,children:[e.jsx("div",{className:"d-none d-lg-block",children:"NUEVO"}),e.jsx("div",{className:"d-lg-none",children:e.jsx(z,{icon:De,size:"sm"})})]})}),e.jsx(n,{xs:"8",lg:"8",children:e.jsxs(Se,{children:[e.jsx(H,{type:"text",name:"searchTerm",placeholder:"Buscar por cliente, número de plan separe...",value:h,onChange:A,onKeyDown:D}),e.jsxs(N,{type:"button",variant:"outline",color:"primary",onClick:()=>C({page:1}),children:[e.jsx("div",{className:"d-none d-lg-block",children:"BUSCAR"}),e.jsx("div",{className:"d-lg-none",children:e.jsx(z,{icon:aa,size:"sm"})})]}),e.jsxs(N,{type:"button",variant:"outline",color:"secondary",onClick:r,children:[e.jsx("div",{className:"d-none d-lg-block",children:"LIMPIAR"}),e.jsx("div",{className:"d-lg-none",children:e.jsx(z,{icon:Ae,size:"sm"})})]})]})}),e.jsx(n,{xs:"2",lg:"2",className:"text-end",children:e.jsxs(N,{type:"button",variant:s?"":"outline",color:"info",onClick:l,children:[e.jsx("div",{className:"d-none d-lg-block",children:"FILTROS"}),e.jsx("div",{className:"d-lg-none",children:e.jsx(z,{icon:ea,size:"sm"})})]})})]}),e.jsx(Ye,{visible:s,children:e.jsx(W,{className:"mt-3 mb-0",children:e.jsxs(G,{children:[e.jsxs(y,{className:"mb-3",children:[e.jsxs(n,{md:"3",children:[e.jsx(T,{children:"Estado"}),e.jsxs(Pe,{name:"status",value:f.status,onChange:_,children:[e.jsx("option",{value:"",children:"Todos"}),e.jsx("option",{value:"ACTIVE",children:"Activo"}),e.jsx("option",{value:"DELIVERED",children:"Entregado"}),e.jsx("option",{value:"CANCELED",children:"Cancelado"})]})]}),e.jsxs(n,{md:"3",children:[e.jsx(T,{children:"Fecha Inicio"}),e.jsx(H,{type:"date",name:"startDate",value:f.startDate,onChange:_})]}),e.jsxs(n,{md:"3",children:[e.jsx(T,{children:"Fecha Fin"}),e.jsx(H,{type:"date",name:"endDate",value:f.endDate,onChange:_})]})]}),e.jsx(y,{className:"mb-3",children:e.jsxs(n,{md:"9",className:"d-flex align-items-end",children:[e.jsx(N,{type:"button",color:"primary",className:"me-2",onClick:$,children:"Aplicar Filtros"}),e.jsx(N,{type:"button",variant:"outline",color:"secondary",onClick:L,children:"Restablecer"})]})})]})})})]}),e.jsxs(G,{children:[e.jsxs("div",{className:"d-lg-none",children:[S?.map(a=>e.jsx(W,{style:{width:"auto",cursor:"pointer"},className:"my-2",onClick:()=>viewLayaway(a._id),children:e.jsxs(G,{children:[e.jsxs(y,{className:"g-0",children:[e.jsxs(n,{xs:"8",children:[e.jsx(y,{className:"fw-bold",children:a.client?.name}),e.jsx(y,{children:J(a.createdAt)})]}),e.jsxs(n,{xs:"4",className:"text-end",children:[e.jsx(ue,{color:ae[a.status]?.color||"secondary",shape:"rounded-pill",children:ae[a.status]?.label||a.status}),e.jsx("div",{className:"fw-bold mt-2",children:F(a.totalAmount)})]})]}),e.jsx(y,{className:"mt-2",children:e.jsxs(n,{children:[e.jsxs("small",{children:["Pagado: ",F(a.paidAmount)," (",c(a),"%)"]}),e.jsx("div",{className:"progress",children:e.jsx("div",{className:`progress-bar bg-${c(a)===100?"success":"primary"}`,role:"progressbar",style:{width:`${c(a)}%`},"aria-valuenow":c(a),"aria-valuemin":"0","aria-valuemax":"100"})})]})})]})},a._id)),e.jsx(y,{children:e.jsxs(n,{className:"py-1 text-center",children:["Página ",u?.currentPage||1," de ",u?.totalPages||1]})}),e.jsxs(y,{children:[e.jsx(n,{children:e.jsx("div",{className:"d-grid col-12 mx-auto",children:e.jsx(N,{type:"button",variant:"outline",color:"secondary",disabled:g||u?.currentPage<=1,onClick:k,children:"ANTERIOR"})})}),e.jsx(n,{children:e.jsx("div",{className:"d-grid col-12 mx-auto",children:e.jsx(N,{type:"button",variant:"outline",color:"secondary",disabled:g||u?.currentPage>=u?.totalPages,onClick:B,children:"SIGUIENTE"})})})]})]}),e.jsx("div",{className:"d-none d-lg-block",children:e.jsxs(se,{hover:!0,children:[e.jsx(he,{children:e.jsxs(U,{children:[e.jsx(I,{scope:"col",children:"Cliente"}),e.jsx(I,{scope:"col",children:"Fecha"}),e.jsx(I,{scope:"col",children:"Monto Total"}),e.jsx(I,{scope:"col",children:"Pagado"}),e.jsx(I,{scope:"col",children:"Progreso"}),e.jsx(I,{scope:"col",children:"Estado"}),e.jsx(I,{scope:"col",children:"Acciones"})]})}),e.jsx(te,{children:S?.map(a=>e.jsxs(U,{children:[e.jsx(w,{className:"text-capitalize text-break",children:a.client?.name}),e.jsx(w,{children:J(a.createdAt)}),e.jsx(w,{children:F(a.totalAmount)}),e.jsx(w,{children:F(a.paidAmount)}),e.jsx(w,{children:e.jsx("div",{className:"progress",children:e.jsxs("div",{className:`progress-bar bg-${c(a)===100?"success":"primary"}`,role:"progressbar",style:{width:`${c(a)}%`},"aria-valuenow":c(a),"aria-valuemin":"0","aria-valuemax":"100",children:[c(a),"%"]})})}),e.jsx(w,{children:e.jsx(ue,{color:ae[a.status]?.color||"secondary",shape:"rounded-pill",children:ae[a.status]?.label||a.status})}),e.jsx(w,{children:e.jsx(N,{size:"sm",variant:"outline",color:"info",onClick:()=>i.onSelect(a._id),children:"VER DETALLES"})})]},a._id))}),e.jsxs(Qe,{children:[e.jsx(U,{children:e.jsxs(w,{colSpan:7,className:"text-center",children:["Página ",u?.currentPage||1," de ",u?.totalPages||1," | Total: ",u?.totalDocs||0," planes separe"]})}),e.jsx(U,{className:"mt-2",children:e.jsx(w,{colSpan:7,children:e.jsxs(y,{children:[e.jsx(n,{className:"text-start",children:e.jsx(N,{type:"button",variant:"outline",color:"secondary",disabled:g||u?.currentPage<=1,onClick:k,children:"ANTERIOR"})}),e.jsx(n,{className:"text-end",children:e.jsx(N,{type:"button",variant:"outline",color:"secondary",disabled:g||u?.currentPage>=u?.totalPages,onClick:B,children:"SIGUIENTE"})})]})})})]})]})})]})]})}Re.propTypes={onNew:R.func.isRequired,onSelect:R.func.isRequired,onEdit:R.func.isRequired,onSearch:R.func.isRequired};const V={LIST:"list",NEW:"new",EDIT:"edit",DETAIL:"detail"};function Da(){const i=X(),o=P(u=>u.layaways.layaway),[h,p]=j.useState(V.LIST),[s,t]=j.useState(null);j.useEffect(()=>{i(ie({page:1}))},[i]);const d=async(u={})=>{i(ie(u))},x=u=>{t(u),p(V.DETAIL),i(Ce(u)),i(Ie(u))},f=()=>{p(V.NEW)},b=u=>{t(u),p(V.EDIT),i(Ce(u))},S=()=>{p(V.LIST),t(null),i(ie({page:1}))},g=u=>{i(sa(u)).then(A=>{A&&S()})};return e.jsx(e.Fragment,{children:e.jsxs(we,{children:[e.jsx(Ue,{children:e.jsx("title",{children:"PLANES SEPARE"})}),h===V.LIST&&e.jsx(Re,{onNew:f,onSelect:x,onEdit:b,onSearch:d}),(h===V.NEW||h===V.EDIT)&&e.jsx(Te,{layaway:h===V.EDIT?o:null,onCancel:S,onSave:g}),h===V.DETAIL&&o&&e.jsx(na,{onBack:S})]})})}export{Da as default};
